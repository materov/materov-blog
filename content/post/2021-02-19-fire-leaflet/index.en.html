---
title: Интерактивные карты на Leaflet
author: admin
date: '2021-01-23'
slug: fire-leaflet
categories: ["R"]
tags: ["rstats", "геоданные"]
subtitle: 'построение интерактивных географических HTML-карт'
summary: 'В статье рассказывается, как используя библиотеку `Leaflet` можно создавать HTML-виджеты для интерактивного просмотра пространственных данных.'
authors: 
- admin
lastmod: '2021-01-25'
featured: yes
math: true
image:
  caption: ''
  focal_point: ''
  preview_only: yes
projects: []
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>


<p><a href="https://leafletjs.com/">Leaflet</a> является одной из самых популярных open-source библиотек на JavaScript для создания интерактивных карт. Соответствующая библиотека <a href="https://rstudio.github.io/leaflet/">Leaflet for R</a> позволяет легко интегрировать интерактивные карты Leaflet как HTML-виджеты. В продолжение <a href="https://materov-blog.netlify.app/post/geodata-fire/">предыдущей записи</a> в блоге по работе с геоданными в <strong>R</strong>, покажем, как можно быстро разработать интерактивную карту пожаров не прибегая при этом к средствам JavaScript.</p>
<p>Пример Leaflet карты, иллюстрирующей пожары в Новосибирске за период с начала 2016 года по середину июля 2020 года, показан ниже. Для удобства отображения большого количества маркеров, отмечающих точки, где произошли пожары, смежные маркеры автоматически группируются в кластеры.</p>
<iframe seamless src="BasicMap.html" width="100%" height="600">
</iframe>
<p>Мы воспроизведем карту выше, а также рассмотрим некоторые другие особенности Leaflet.</p>
<div id="исходные-данные" class="section level1">
<h1>Исходные данные</h1>
<p>Подключим небходимые библиотеки в <strong>R</strong>.</p>
<pre class="r"><code>library(tidyverse)
library(magrittr)
library(RCurl)

library(leaflet)</code></pre>
<p>Загрузим <strong>данные по пожарам в Новосибирске</strong><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> за последние несколько лет.</p>
<pre class="r"><code>url &lt;- getURL(&quot;https://raw.githubusercontent.com/materov/blog_data/main/fire_NSK.csv&quot;)
fire &lt;- read.csv(text = url)
fire %&lt;&gt;% as_tibble()

fire</code></pre>
<pre><code>## # A tibble: 6,379 x 13
##        X NOMER_ZVK DATE_ZVK ADDRES RIDE_TYPE OBJECT_CATEGORIE geo_lon geo_lat
##    &lt;int&gt;     &lt;int&gt; &lt;fct&gt;    &lt;fct&gt;  &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;   &lt;dbl&gt;
##  1     1   1600038 2016-01… ул. М… Тушение … Транспортные ср…    82.9    55.1
##  2     2   1600071 2016-01… ул. Ш… Тушение … Многоквартирный…    83.1    54.9
##  3     3   1600255 2016-01… ул. К… Тушение … Многоквартирный…    83.0    55.0
##  4     4   1600284 2016-01… ул. П… Тушение … Транспортные ср…    83.1    55.0
##  5     5   1600287 2016-01… ул. Н… Тушение … Многоквартирный…    83.0    55.1
##  6     6   1600319 2016-01… ул. Ф… Тушение … Здания производ…    82.9    55.0
##  7     7   1600410 2016-01… ул. В… Тушение … Одноквартирный …    83.0    55.0
##  8     8   1600412 2016-01… мрн. … Тушение … Многоквартирный…    82.9    55.0
##  9     9   1600435 2016-01… ул. Ш… Тушение … Прочие обьекты …    82.9    55.0
## 10    10   1600436 2016-01… ул. С… Тушение … Транспортные ср…    82.9    55.0
## # … with 6,369 more rows, and 5 more variables: PRIB_TIME &lt;int&gt;,
## #   LOC_TIME &lt;int&gt;, LPP_TIME &lt;int&gt;, SQUARE_LOC &lt;dbl&gt;, PERSONNEL &lt;dbl&gt;</code></pre>
<p>Основные интересующие нас переменные – широта и долгота: <code>geo_lat</code> и <code>geo_lon</code>.</p>
<pre class="r"><code>fire_geo &lt;-
fire %&gt;% 
  select(geo_lat, geo_lon) %&gt;% 
  purrr::set_names(&quot;lat&quot;, &quot;long&quot;) 

fire_geo</code></pre>
<pre><code>## # A tibble: 6,379 x 2
##      lat  long
##    &lt;dbl&gt; &lt;dbl&gt;
##  1  55.1  82.9
##  2  54.9  83.1
##  3  55.0  83.0
##  4  55.0  83.1
##  5  55.1  83.0
##  6  55.0  82.9
##  7  55.0  83.0
##  8  55.0  82.9
##  9  55.0  82.9
## 10  55.0  82.9
## # … with 6,369 more rows</code></pre>
</div>
<div id="построение-базовой-карты" class="section level1">
<h1>Построение базовой карты</h1>
<p>Для построения подложки интерактивной карты необходимо в первую очередь выбрать координаты центра карты и базовое увеличение командой <code>setView()</code>.</p>
<pre class="r"><code>lng_center &lt;- 82.9
lat_center &lt;- 55

leaflet(fire_geo) %&gt;%
  setView(lng = lng_center, lat = lat_center, zoom = 11)  %&gt;% 
  addTiles()</code></pre>
<iframe seamless src="ZeroMap.html" width="100%" height="600">
</iframe>
</div>
<div id="нанесение-данных-на-карту" class="section level1">
<h1>Нанесение данных на карту</h1>
<div id="маркеры" class="section level2">
<h2>Маркеры</h2>
<p>Точки на карте, отвечающие пожарам, можно добавить командой <code>addMarkers()</code>. В качестве примера рассмотрим только категорию объектов пожара <em>Садовый дом, дача</em>.</p>
<pre class="r"><code>fire %&gt;% 
  filter(OBJECT_CATEGORIE == &quot;Садовый дом, дача&quot;) %&gt;% 
  select(geo_lat, geo_lon) %&gt;% 
  purrr::set_names(&quot;lat&quot;, &quot;long&quot;) %&gt;% 
  leaflet() %&gt;%
  setView(lng = lng_center, lat = lat_center, zoom = 11)  %&gt;% 
  addTiles() %&gt;% 
  addMarkers()</code></pre>
<iframe seamless src="AddMarkersMap.html" width="100%" height="600">
</iframe>
</div>
<div id="кластеры" class="section level2">
<h2>Кластеры</h2>
<p>Для большого количества данных маркеры могут сливаться, поэтому сгруппируем их используя опцию <code>clusterOptions</code>.</p>
<pre class="r"><code>leaflet(fire_geo) %&gt;%
  setView(lng = lng_center, lat = lat_center, zoom = 11)  %&gt;% 
  addTiles() %&gt;% 
  addMarkers(
  clusterOptions = markerClusterOptions()
)</code></pre>
<iframe seamless src="AddClustersMap.html" width="100%" height="600">
</iframe>
<p>По сути, наша карта готова. Тем не менее, ее можно улучшить, рассмотрев дополнительные возможности, предоставляемые Leaflet.</p>
</div>
<div id="слои-карт" class="section level2">
<h2>Слои карт</h2>
<p>OpenStreetMap позволяет добавлять на карту различные слои.</p>
<pre class="r"><code>leaflet() %&gt;% 
  setView(lng = lng_center, lat = lat_center, zoom = 11) %&gt;% 
  addTiles() %&gt;% 
  addProviderTiles(providers$OpenFireMap)
) </code></pre>
<div class="figure">
<img src="OpenFireMap.png" alt="" />
<p class="caption">Пример слоя OpenFireMap</p>
</div>
<p>Например, актуальным является слой OpenFireMap, который наносит на карту пожарные части, гидранты и пожарные водоемы.
Полный список подключаемых карт содержится в переменной <code>providers</code>.</p>
<pre class="r"><code>head(leaflet::providers, 5)</code></pre>
<pre><code>## $OpenStreetMap
## [1] &quot;OpenStreetMap&quot;
## 
## $OpenStreetMap.Mapnik
## [1] &quot;OpenStreetMap.Mapnik&quot;
## 
## $OpenStreetMap.DE
## [1] &quot;OpenStreetMap.DE&quot;
## 
## $OpenStreetMap.CH
## [1] &quot;OpenStreetMap.CH&quot;
## 
## $OpenStreetMap.France
## [1] &quot;OpenStreetMap.France&quot;</code></pre>
<p>Соотнести слои с их названиями можно используя соответствующую <a href="http://leaflet-extras.github.io/leaflet-providers/preview/index.html">веб-страницу</a>.</p>
</div>
<div id="вид-и-форма-маркеров" class="section level2">
<h2>Вид и форма маркеров</h2>
<p>Маркеры могут быть двух видов: в виде <em>иконок</em> и <em>кругов</em>.
Подробно о виде и форме маркеров можно прочесть на <a href="https://rstudio.github.io/leaflet/markers.html">сайте библиотеки Leaflet</a>. Ограничимся только пожарами на транспортных средствах.
Сделаем карту так, чтобы при наведении на маркер всплывал адрес пожара.</p>
<p>Разделим маркеры на две категории по цвету, соответствующие пожарам:</p>
<ul>
<li>обозначим зеленым цветом маркеры, где время прибытия пожарно-спасательных подразделений составило не более 10 минут;</li>
<li>красные маркеры соответствуют времени прибытия более 10 минут.</li>
</ul>
<pre class="r"><code># цвет маркеров
getColor &lt;- function(fire) {
  sapply(fire$PRIB_TIME, function(PRIB_TIME) {
    if(PRIB_TIME &lt;= 10) {
      &quot;green&quot;
    } else {
      &quot;red&quot;
    } })
}

# вид маркеров
icons &lt;- awesomeIcons(
  icon      = &#39;ios-flame&#39;,
  iconColor = &#39;black&#39;,
  library   = &#39;ion&#39;,
  markerColor = getColor(fire)
)

library(htmltools)

leaflet() %&gt;%
  setView(lng = 82.86, lat = 55, zoom = 13) %&gt;% 
  addTiles() %&gt;% 
  addAwesomeMarkers(data = fire %&gt;% 
                    filter(OBJECT_CATEGORIE == &quot;Транспортные средства&quot;),
                    lng = ~geo_lon, lat = ~geo_lat,  
                    label = ~htmlEscape(ADDRES),
                    icon = icons
  )</code></pre>
<iframe seamless src="AddAwesomeMarkers.html" width="100%" height="600">
</iframe>
<p>Как говорилось ранее, маркеры можно представлять и в виде кругов.
Применим эту возможность для отображения площади пожаров, подобрав при этом радиус окружности маркера так, чтобы он в некотором масштабе соответствовал площади возгорания.</p>
<pre class="r"><code>leaflet() %&gt;%
  setView(lng = 82.87, lat = 55, zoom = 12.5) %&gt;% 
  addTiles() %&gt;% 
  addCircleMarkers(data = fire, 
                   lng = ~geo_lon, lat = ~geo_lat, 
    radius = 5*log10(fire$SQUARE_LOC),
    stroke = FALSE, fillOpacity = 0.4
  )</code></pre>
<iframe seamless src="SquareMarkers.html" width="100%" height="600">
</iframe>
</div>
<div id="интерактиваная-легенда" class="section level2">
<h2>Интерактиваная легенда</h2>
<p>Теперь попробуем соеденить некоторые возможности, которые мы рассмотрели, и создадим карту на которой мы могли бы выбирать темы подложки и основные типы интересующих нас объектов горения с помощью легенды.</p>
<pre class="r"><code>leaflet() %&gt;%
  setView(lng = lng_center, lat = lat_center, zoom = 11) %&gt;% 
  addTiles(options = providerTileOptions(noWrap = TRUE), 
           group = &quot;Базовая тема (OpenStreetMap)&quot;) %&gt;%
  addProviderTiles(&quot;CartoDB.DarkMatter&quot;, 
           group = &quot;Темная тема (CartoDB)&quot;) %&gt;%
  addProviderTiles(&quot;Esri.WorldImagery&quot;, 
           group = &quot;Спутник&quot;) %&gt;%  
  addTiles() %&gt;% 
  addAwesomeMarkers(data = fire %&gt;% 
                      filter(OBJECT_CATEGORIE %in% c(&quot;Одноквартирный жилой дом&quot;, 
                                                     &quot;Многоквартирный жилой дом&quot;)), 
             lng = ~geo_lon, lat = ~geo_lat, 
             group = &quot;Жилые дома&quot;,  
             label = ~htmlEscape(ADDRES),
    clusterOptions = markerClusterOptions()
  )  %&gt;% 
  addAwesomeMarkers(data = fire %&gt;% 
                      filter(OBJECT_CATEGORIE %in% c(&quot;Транспортные средства&quot;)), 
             lng = ~geo_lon, lat = ~geo_lat, 
             group = &quot;Транспортные средства&quot;,
             label = ~htmlEscape(ADDRES),
             clusterOptions = markerClusterOptions()
  )  %&gt;% 
  addAwesomeMarkers(data = fire %&gt;% 
                      filter(OBJECT_CATEGORIE %in% c(&quot;Надворные постройки&quot;)), 
             lng = ~geo_lon, lat = ~geo_lat, 
             group = &quot;Надворные постройки&quot;, 
             label = ~htmlEscape(ADDRES),
             clusterOptions = markerClusterOptions()
  )  %&gt;% 
  addLayersControl(overlayGroups = c(&quot;Жилые дома&quot;, 
                                     &quot;Транспортные средства&quot;, 
                                     &quot;Надворные постройки&quot;),
    baseGroups = c(&quot;Базовая тема (OpenStreetMap)&quot;, 
                                  &quot;Темная тема (CartoDB)&quot;,
                                  &quot;Спутник&quot;), 
    position = c(&quot;bottomleft&quot;),
                   options = layersControlOptions(collapsed = FALSE)) %&gt;% 
  hideGroup(&quot;Транспортные средства&quot;) %&gt;% 
  hideGroup(&quot;Надворные постройки&quot;)</code></pre>
<iframe seamless src="Add_Legend.html" width="100%" height="600">
</iframe>
</div>
<div id="использование-crosstalk" class="section level2">
<h2>Использование Crosstalk</h2>
<p>Предыдущая карта содержит легенду, способную взаимодействовать с картой.
Несмотря на это, в карте отсутствует динамическая фильтрация данных. Включить ее в полной мере можно, например, с помощью <a href="https://shiny.rstudio.com/">Shiny</a> – инструмента создания интерактивных веб-приложений.</p>
<p>Разработанное в Shiny приложение может запускаться на исполнение с сервера:</p>
<ul>
<li>со специального облачного сервера <a href="https://www.shinyapps.io/">shinyapps.io</a>;</li>
<li>выполняться на локальном сервере пользователя;</li>
<li>выполняться на платном сервере RStudio.</li>
</ul>
<p>Использование сервера не всегда удобно, и написание приложений в Shiny требует специальных навыков. Другой способ введения интерактивности, – разработка приложений в <a href="https://rstudio.github.io/crosstalk/using.html">Crosstalk</a>, который обладает меньшими возможностями, но не требует сервера. В качестве примера рассмотрим пожары в одноквартирных и многоквартирных жилых домах в период с 1 января 2020 года.</p>
<p>Подготовим данные и сделаем карту в <code>crosstalk</code>.</p>
<pre class="r"><code>library(crosstalk)

# подготовка данных
fire_filtered &lt;- fire %&gt;% 
  filter(OBJECT_CATEGORIE %in% c(&quot;Одноквартирный жилой дом&quot;,
                                 &quot;Многоквартирный жилой дом&quot;)) %&gt;% 
  filter(DATE_ZVK &gt;= &quot;2020-01-01&quot;) %&gt;% 
  rename(lat = &quot;geo_lat&quot;, long = &quot;geo_lon&quot;)

shared_fire &lt;- SharedData$new(fire_filtered)</code></pre>
<pre class="r"><code># отрисовка карты
bscols(widths = c(2,NA, NA),
       list(
         filter_checkbox(&quot;OBJECT_CATEGORIE&quot;, &quot;Категория объекта&quot;, 
                         shared_fire, ~OBJECT_CATEGORIE, inline = F),
         filter_slider(&quot;PRIB_TIME&quot;, &quot;Время прибытия&quot;, 
                       shared_fire, column = ~PRIB_TIME, step = 1, width = &quot;100%&quot;) 
       ),
  leaflet(shared_fire, width = &quot;100%&quot;, height = 600) %&gt;% 
    setView(lng = lng_center, lat = lat_center, zoom = 11) %&gt;%
    addTiles() %&gt;% 
    addMarkers()
)</code></pre>
<iframe seamless src="Crosstalk_Map.html" width="100%" height="600">
</iframe>
</div>
</div>
<div id="заключение" class="section level1">
<h1>Заключение</h1>
<p>Мы коснулись лишь небольшой части тех возможностей, которыми обладает библиотека Leaflet, однако даже те инструменты, обзор которых здесь представлен, позволяют существенно упростить визуализацию информации связанной с планированием предотвращения последствий различных чрезвычайных ситуаций.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Автор выражает благодарность <a href="https://www.sibpsa.ru/ntc/management/?ELEMENT_ID=748">О.С. Малютину</a> за предоставленные данные.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
